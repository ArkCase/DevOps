# Copyright (c) 2020 Armedia, LLC
---
AWSTemplateFormatVersion: 2010-09-09

Description: >
  Deploy ArkCase

Parameters:
  Env:
    Type: String
    Description: Type of environment to provision
    Default: prod
    AllowedValues: [ staging, prod, dev, test, load-test ]

  Project:
    Type: String
    Description: Name of the project (or product)
    Default: arkcase
    MinLength: 1
    MaxLength: 30
    AllowedPattern: ^[-_.a-zA-Z0-9]*$
    ConstraintDescription: >
      Up to 30 alpha-numeric characters; can use underscores,
      dots and dashes

  VpcCidr:
    Type: String
    Description: CIDR block for the VPC
    MinLength: 9
    MaxLength: 18
    AllowedPattern: ^\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3}/\d{1,2}$
    ConstraintDescription: Must be a valid CIDR range like "10.10.0.0/16"
    Default: 10.210.0.0/16

  MaintenanceWindowStart:
    Type: String
    Description: >
      Weekly maintenance window for the whole deployment. Must be in the
      format "DDD:HH:MM" and must be in UTC time. "DDD" is the three-letter day
      of the week (eg: "Sun"); "HH" is the hour in 24h format; "MM" is the
      minutes. We strongly recommend you use Sunday early morning in your own
      time zone. The maintenance would typically take a couple of hours.
    Default: Sun:08:00
    AllowedPattern: ^[a-zA-Z]{3}:[0-2][0-9]:[0-5][0-9]$
    ConstraintDescription: Must be in the format "DDD:HH:MM"

  DsEdition:
    Type: String
    Description: Whether Directory Services is Enterprise or Standard
    Default: Standard
    AllowedValues: [ Enterprise, Standard ]

  DsName:
    Type: String
    Description: |
      The fully qualified domain name for the AWS Managed Microsoft AD directory, such as
      corp.example.com. This name will resolve inside your VPC only. It does not need to be
      publicly resolvable.
    AllowedPattern: ^([a-zA-Z0-9]+[\\.-])+([a-zA-Z0-9])+$
    ConstraintDescription: Must be a valid fully qualified domain name.
    Default: ecmontap.com

  DsPassword:
    Type: String
    Description: |
      The password for the default administrative user named Admin. The
      password must be between 12 and 64 characters, not contain the
      word "admin", and must have at least one character from three of these
      four categories: lowercase, uppercase, numeric and special characters
    NoEcho: true
    MinLength: 12
    MaxLength: 64
    AllowedPattern: (?=^.{12,64}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9\s])(?=.*[a-z])|(?=.*[^A-Za-z0-9\s])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9\s]))^.*
    ConstraintDescription: >
      12-64 characters; must have at least one character from three of these
      four categories: lowercase, uppercase, numeric and special characters

  AmazonmqInstanceType:
    Type: String
    Description: The instance type to use for the AmazonMQ broker
    Default: mq.m5.large
    AllowedValues:
      - mq.t2.micro
      - mq.m5.large
      - mq.m5.xlarge
      - mq.m5.2xlarge
      - mq.m5.4xlarge

  ActivemqVersion:
    Type: String
    Description: ActiveMQ version to use
    Default: 5.15.10
    AllowedValues: [ 5.15.10, 5.15.9, 5.15.8, 5.15.6, 5.15.0 ]

  AmazonmqEnableAuditLogs:
    Type: String
    Description: Whether to enable audit logs for the AmazonMQ broker
    Default: false
    AllowedValues: [ true, false ]

  PasswordsLength:
    Type: Number
    Description: >
      How long passwords should be for various AWS services
    Default: 20
    MinValue: 12
    MaxValue: 80

  MariadbRdsInstanceClass:
    Type: String
    Description: >
      RDS instance class for the database; for more detail, refer to the
      official AWS documentation here:
      https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.DBInstanceClass.html
    Default: db.t3.small
    AllowedValues: [ db.m5.24xlarge, db.m5.16xlarge, db.m5.12xlarge, db.m5.8xlarge, db.m5.4xlarge, db.m5.4xlarge, db.m5.2xlarge, db.m5.xlarge, db.m5.large,
                     db.m4.16xlarge, db.m4.10xlarge, db.m4.4xlarge, db.m4.2xlarge, db.m4.xlarge, db.m4.large,
                     db.z1d.12xlarge, db.z1d.6xlarge, db.z1d.3xlarge, db.z1d.2xlarge, db.z1d.xlarge, db.z1d.large,
                     db.x1e.32xlarge, db.x1e.16xlarge, db.x1e.8xlarge, db.x1e.4xlarge, db.x1e.2xlarge, db.x1e.xlarge,
                     db.x1.32xlarge, db.x1.16xlarge,
                     db.r5.24xlarge, db.r5.16xlarge, db.r5.12xlarge, db.r5.8xlarge, db.r5.4xlarge, db.r5.2xlarge, db.r5.xlarge, db.r5.large,
                     db.r4.16xlarge, db.r4.8xlarge, db.r4.4xlarge, db.r4.2xlarge, db.r4.xlarge, db.r4.large,
                     db.t3.2xlarge, db.t3.xlarge, db.t3.large, db.t3.medium, db.t3.small, db.t3.micro,
                     db.t2.2xlarge, db.t2.xlarge, db.t2.large, db.t2.medium, db.t2.small, db.t2.micro ]

  MariadbRdsDiskSizeGB:
    Type: Number
    MinValue: 20
    Default: 50

  MariadbRdsEnableHotStandby:
    Type: String
    Description: >
      If this is set to `true`, RDS will maintain a hot standy in a different
      Availability Zone. This will make the database highly available, but
      will cost more. Please note this has no effect on performance.
    Default: true
    AllowedValues: [ true, false ]

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: { default: IMPORTANT PARAMETERS }
        Parameters:
          - Env
          - VpcCidr
          - MaintenanceWindowStart

      - Label: { default: Definition (this and the following sections are less important) }
        Parameters:
          - Project

      - Label: { default: General security }
        Parameters:
          - PasswordsLength

      - Label: { default: Database configuration }
        Parameters:
          - MariadbRdsInstanceClass
          - MariadbRdsDiskSizeGB
          - MariadbRdsEnableHotStandby

      - Label: { default: Directory Services Configuration }
        Parameters:
          - DsEdition
          - DsName
          - DsPassword

      - Label: { default: Amazon MQ }
        Parameters:
          - AmazonmqInstanceType
          - ActivemqVersion
          - AmazonmqEnableAuditLogs

    ParameterLabels:
      Env: { default: Environment }
      VpcCidr: { default: VPC CIDR block }
      MaintenanceWindowStart: { default: Start of weekly maintenance window }
      DsEdition: { default: Directory Services Edition }
      DsName: { default: Domain Name }
      DsPassword: { default: Admin User Password }
      AmazonmqInstanceType: { default: AmazonMQ instance type }
      ActivemqVersion: { default: ActiveMQ version }
      AmazonmqEnableAuditLogs: { default: Enable AmazonMQ audit logs }
      PasswordsLength: { default: Passwords length }
      MariadbRdsInstanceClass: { default: MariaDB RDS instance class }
      MariadbRdsDiskSizeGB: { default: "MariaDB RDS disk size, in GB" }
      MariadbRdsEnableHotStandby: { default: Enable MariaDB RDS hot standby }

Resources:

  #######
  # VPC #
  #######

  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub vpc-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub internet-gateway-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref Vpc
      InternetGatewayId: !Ref InternetGateway

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      CidrBlock: !Select [ 0, !Cidr [ !Ref VpcCidr, 4, 10 ] ]
      AvailabilityZone: !Select [ 0, !GetAZs ]
      Tags:
        - Key: Name
          Value: !Sub public-subnet-A-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      CidrBlock: !Select [ 1, !Cidr [ !Ref VpcCidr, 4, 10 ] ]
      AvailabilityZone: !Select [ 1, !GetAZs ]
      Tags:
        - Key: Name
          Value: !Sub public-subnet-B-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      CidrBlock: !Select [ 2, !Cidr [ !Ref VpcCidr, 4, 10 ] ]
      AvailabilityZone: !Select [ 0, !GetAZs ]
      Tags:
        - Key: Name
          Value: !Sub private-subnet-A-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      CidrBlock: !Select [ 3, !Cidr [ !Ref VpcCidr, 4, 10 ] ]
      AvailabilityZone: !Select [ 1, !GetAZs ]
      Tags:
        - Key: Name
          Value: !Sub private-subnet-B-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  ElasticIpForNatGateway:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub elastic-ip-for-nat-gateway-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ElasticIpForNatGateway.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
        - Key: Name
          Value: !Sub nat-gateway-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub public-route-table-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub private-route-table-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTable

  ###############################
  # Compute Maintenance Windows #
  ###############################

  MaintenanceWindowsLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Name
          Value: !Sub maintenance-windows-lambda-execution-role-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: admin
        - Key: Component
          Value: iam
        - Key: ManagedBy
          Value: CloudFormation

  MaintenanceWindowsLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Calculate ArkCase maintenance windows
      Runtime: python3.7
      Role: !GetAtt MaintenanceWindowsLambdaExecutionRole.Arn
      Handler: maintenance_windows.handler
      Timeout: 5
      Code:
        S3Bucket: !Sub arkcase-public-${AWS::Region}
        S3Key: DevOps/ACM-TMP-20200703-1316/LambdaFunctions/maintenance_windows/maintenance_windows.zip
      Tags:
        - Key: Name
          Value: !Sub maintenance-windows-lambda-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: admin
        - Key: Component
          Value: lambda
        - Key: ManagedBy
          Value: CloudFormation

  MaintenanceWindows:
    Type: Custom::MaintenanceWindows
    Properties:
      ServiceToken: !GetAtt MaintenanceWindowsLambda.Arn
      Start: !Ref MaintenanceWindowStart
      # The following random token is not used by the Lambda function; its
      # only purpose is to force the Lambda function to be called every time
      # the stack is updated. The reason is that CloudFormation doesn't call
      # the Lambda function during an update unless there is a change in the
      # input parameters.
      RandomToken: ACM-TMP-20200703-1316

  ######################################
  # Microsoft Active Directory Service #
  ######################################

  DirectoryService:
    Type: AWS::DirectoryService::MicrosoftAD
    Properties:
      Name: !Ref DsName
      Password: !Ref DsPassword
      Edition: !Ref DsEdition
      VpcSettings:
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
        VpcId: !Ref Vpc
      # AWS::DirectoryService::MicrosoftAD doesn't support Tags :-(

  ############
  # AmazonMQ #
  ############

  Amazonmq:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://arkcase-public-us-east-1.s3.amazonaws.com/DevOps/ACM-TMP-20200703-1316/CloudFormation/amazonmq.yml
      TimeoutInMinutes: 30
      Parameters:
        Env: !Ref Env
        Project: !Ref Project
        VpcId: !Ref Vpc
        SubnetIdA: !Ref PrivateSubnetA
        SubnetIdB: !Ref PrivateSubnetB
        InstanceType: !Ref AmazonmqInstanceType
        PasswordLength: !Ref PasswordsLength
        ActivemqVersion: !Ref ActivemqVersion
        MaintenanceDayOfWeek: !GetAtt MaintenanceWindows.StartAmazonmqMaintenanceDayOfWeek
        MaintenanceTimeOfDay: !GetAtt MaintenanceWindows.StartAmazonmqMaintenanceTimeOfDay
        EnableAuditLogs: !Ref AmazonmqEnableAuditLogs
      Tags:
        - Key: Name
          Value: !Sub amazonmq-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: amazonmq
        - Key: Component
          Value: cfn
        - Key: ManagedBy
          Value: CloudFormation

  ############
  # Database #
  ############

  # Security groups

  MariadbLambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for the Lambda functions that access MariaDB
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub mariadb-lambda-security-group-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  MariadbAllowedSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group that can access the MariaDB RDS instance
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub mariadb-allowed-security-group-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  MariadbInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for the MariaDB RDS instance
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        - Description: Allow traffic from MariaDB-related Lambda functions
          IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !GetAtt MariadbLambdaSecurityGroup.GroupId
        - Description: Allow traffic from authorized security group
          IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !GetAtt MariadbAllowedSecurityGroup.GroupId
      Tags:
        - Key: Name
          Value: !Sub mariadb-instance-security-group-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  # MariaDB Master Secret

  MariadbMasterSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: Master secret
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username": "master"}'
        GenerateStringKey: password
        PasswordLength: !Ref PasswordsLength
        ExcludeCharacters: "'/@\"\\%"
      Tags:
        - Key: Name
          Value: !Sub mariadb-master-secret-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: secretsmanager
        - Key: ManagedBy
          Value: CloudFormation

  MariadbMasterSecretPolicy:
    Type: AWS::SecretsManager::ResourcePolicy
    Properties:
      SecretId: !Ref MariadbMasterSecret
      ResourcePolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Deny
            Principal:
              AWS: !Ref AWS::AccountId
            Action: secretsmanager:DeleteSecret
            Resource: "*"

  # MariaDB Master Secret Rotation Lambda

  MariadbMasterRotationLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: SecretsManagerRotationPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:DescribeSecret
                  - secretsmanager:GetSecretValue
                  - secretsmanager:PutSecretValue
                  - secretsmanager:UpdateSecretVersionStage
                Resource: !Ref MariadbMasterSecret

              - Effect: Allow
                Action: secretsmanager:GetRandomPassword
                Resource: "*"
      Tags:
        - Key: Name
          Value: !Sub mariadb-master-secret-rotation-lambda-execution-role-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: iam
        - Key: ManagedBy
          Value: CloudFormation

  MariadbMasterRotationLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Rotate MariaDB master secret
      Runtime: python3.7
      Role: !GetAtt MariadbMasterRotationLambdaExecutionRole.Arn
      Handler: mariadb_master_rotation.handler
      Timeout: 30
      VpcConfig:
        SecurityGroupIds: [ !GetAtt MariadbLambdaSecurityGroup.GroupId ]
        SubnetIds: [ !Ref PrivateSubnetA, !Ref PrivateSubnetB ]
      Environment:
        Variables:
          PASSWORD_LENGTH: !Ref PasswordsLength
      Code:
        S3Bucket: !Sub arkcase-public-${AWS::Region}
        S3Key: DevOps/ACM-TMP-20200703-1316/LambdaFunctions/mariadb_master_rotation/mariadb_master_rotation.zip
      Tags:
        - Key: Name
          Value: !Sub mariadb-master-rotation-lambda-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: lambda
        - Key: ManagedBy
          Value: CloudFormation

  MariadbMasterRotationLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref MariadbMasterRotationLambda
      Action: lambda:InvokeFunction
      Principal: secretsmanager.amazonaws.com

  # MariaDB Master Secret Rotation Schedule

  MariadbMasterSecretRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    # NB: When CloudFormation initially creates this resource, SecretsManager
    #     will initate a secret rotation. So it's better to ensure everything
    #     is in place beforehand. SecretsManager will perform retries
    #     otherwise, but it's cleaner this way.
    DependsOn: [ MariadbMasterSecretAttachment, MariadbMasterRotationLambdaInvokePermission ]
    Properties:
      SecretId: !Ref MariadbMasterSecret
      RotationLambdaARN: !GetAtt MariadbMasterRotationLambda.Arn
      RotationRules:
        # NB: Password rotation will be triggered by a CloudWatch event, check
        #     the `MariadbMasterTriggerRule` resource.
        AutomaticallyAfterDays: 1000

  MariadbMasterTriggerLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: TriggerPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: secretsmanager:RotateSecret
                Resource: !Ref MariadbMasterSecret
      Tags:
        - Key: Name
          Value: !Sub mariadb-master-trigger-lambda-execution-role-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: iam
        - Key: ManagedBy
          Value: CloudFormation

  MariadbMasterTriggerLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Trigger a master secret rotation
      Runtime: python3.7
      Role: !GetAtt MariadbMasterTriggerLambdaExecutionRole.Arn
      Handler: rotation_trigger.handler
      Timeout: 30
      Code:
        S3Bucket: !Sub arkcase-public-${AWS::Region}
        S3Key: DevOps/ACM-TMP-20200703-1316/LambdaFunctions/rotation_trigger/rotation_trigger.zip
      Tags:
        - Key: Name
          Value: !Sub mariadb-master-trigger-lambda-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: lambda
        - Key: ManagedBy
          Value: CloudFormation

  MariadbMasterTriggerRule:
    Type: AWS::Events::Rule
    Properties:
      Description: Periodically trigger a master secret rotation
      ScheduleExpression: !Sub cron(${MaintenanceWindows.StartRotateMasterPasswords})
      State: ENABLED
      Targets:
        - Id: MariadbMasterTrigger
          Arn: !GetAtt MariadbMasterTriggerLambda.Arn
          Input: !Sub '{"SecretArn": "${MariadbMasterSecret}"}'

  MariadbMasterTriggerInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref MariadbMasterTriggerLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt MariadbMasterTriggerRule.Arn

  # MariaDB RDS instance

  MariadbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet for the MariaDB RDS instance
      SubnetIds: [ !Ref PrivateSubnetA, !Ref PrivateSubnetB ]
      Tags:
        - Key: Name
          Value: !Sub mariadb-db-subnet-group-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: rds
        - Key: ManagedBy
          Value: CloudFormation

  MariadbParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: MariaDB Parameter Group
      Family: mariadb10.4
      Parameters:
        max_allowed_packet: 1073741824
        skip_name_resolve: 1
        log_bin_trust_function_creators: 1
      Tags:
        - Key: Name
          Value: !Sub mariadb-parameter-group-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: rds
        - Key: ManagedBy
          Value: CloudFormation

  MariadbInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceClass: !Ref MariadbRdsInstanceClass
      Engine: mariadb
      EngineVersion: 10.4.8
      AutoMinorVersionUpgrade: true
      StorageType: gp2
      StorageEncrypted: true
      AllocatedStorage: !Ref MariadbRdsDiskSizeGB
      BackupRetentionPeriod: 35
      VPCSecurityGroups: [ !GetAtt MariadbInstanceSecurityGroup.GroupId ]
      DBSubnetGroupName: !Ref MariadbSubnetGroup
      DBParameterGroupName: !Ref MariadbParameterGroup
      MultiAZ: !Ref MariadbRdsEnableHotStandby
      PubliclyAccessible: false
      PreferredBackupWindow:
        !Sub ${MaintenanceWindows.StartRdsBackup}-${MaintenanceWindows.EndRdsBackup}
      PreferredMaintenanceWindow:
        !Sub ${MaintenanceWindows.StartRdsMaintenance}-${MaintenanceWindows.EndRdsMaintenance}
      MasterUsername: !Sub "{{resolve:secretsmanager:${MariadbMasterSecret}:SecretString:username}}"
      MasterUserPassword: !Sub "{{resolve:secretsmanager:${MariadbMasterSecret}:SecretString:password}}"
      CACertificateIdentifier: rds-ca-2019
      Tags:
        - Key: Name
          Value: !Sub mariadb-rds-instance-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: database
        - Key: Component
          Value: rds
        - Key: ManagedBy
          Value: CloudFormation

  MariadbMasterSecretAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref MariadbMasterSecret
      TargetType: AWS::RDS::DBInstance
      TargetId: !Ref MariadbInstance

  # Lambda function for CFN custom resource to create a database

  MariadbCreateDatabaseLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: CreateDatabasePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: secretsmanager:GetSecretValue
                Resource: !Ref MariadbMasterSecret
      Tags:
        - Key: Name
          Value: !Sub mariadb-create-database-lambda-execution-role-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: admin
        - Key: Component
          Value: iam
        - Key: ManagedBy
          Value: CloudFormation

  MariadbCreateDatabaseLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Create a database/schema in a MariaDB server
      Runtime: python3.7
      Role: !GetAtt MariadbCreateDatabaseLambdaExecutionRole.Arn
      Handler: mariadb_create_database.handler
      Timeout: 30
      VpcConfig:
        SecurityGroupIds: [ !GetAtt MariadbLambdaSecurityGroup.GroupId ]
        SubnetIds: [ !Ref PrivateSubnetA, !Ref PrivateSubnetB ]
      Code:
        S3Bucket: !Sub arkcase-public-${AWS::Region}
        S3Key: DevOps/ACM-TMP-20200703-1316/LambdaFunctions/mariadb_create_database/mariadb_create_database.zip
      Tags:
        - Key: Name
          Value: !Sub mariadb-create-database-lambda-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: admin
        - Key: Component
          Value: lambda
        - Key: ManagedBy
          Value: CloudFormation

  ############
  # Alfresco #
  ############

  AlfrescoDatabase:
    Type: Custom::MariadbDatabase
    # NB: The Lambda function needs the secret to have the `host` fields etc.
    #     So we need to wait until the attachment is done.
    DependsOn: MariadbMasterSecretAttachment
    # NB: Upon deletion, for some reason, the backend Lambda function times out
    #     trying to communicate with the `ResponseURL`. In order to work around
    #     that CloudFormation bug, tell CloudFormation to not delete this
    #     `AlfrescoDatabase` custom resource.
    #     Please note that this does not mean that the database will not be
    #     destroyed. It will, along with the RDS instance.
    DeletionPolicy: Retain
    Properties:
      ServiceToken: !GetAtt MariadbCreateDatabaseLambda.Arn
      SecretArn: !Ref MariadbMasterSecret
      DatabaseName: alfresco
      Tags:
        - Key: Name
          Value: !Sub alfresco-database-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: alfresco
        - Key: Component
          Value: database
        - Key: ManagedBy
          Value: CloudFormation

  AlfrescoDatabaseUser:
    Type: AWS::CloudFormation::Stack
    # Make sure the user is created after the database
    DependsOn: AlfrescoDatabase
    Properties:
      TemplateURL: https://arkcase-public-us-east-1.s3.amazonaws.com/DevOps/ACM-TMP-20200703-1316/CloudFormation/mariadb-user-secret.yml
      TimeoutInMinutes: 5
      Parameters:
        Env: !Ref Env
        Project: !Ref Project
        SubnetIds: !Join [ ",", [ !Ref PrivateSubnetA, !Ref PrivateSubnetB ] ]
        RotationLambdaSecurityGroupId: !GetAtt MariadbLambdaSecurityGroup.GroupId
        RdsInstanceId: !Ref MariadbInstance
        DatabaseName: alfresco
        Username: alfresco
        PasswordLength: !Ref PasswordsLength
        UserSecretRotationCron: !GetAtt MaintenanceWindows.StartRotateUserPasswords
        MasterSecretArn: !Ref MariadbMasterSecret
      Tags:
        - Key: Name
          Value: !Sub alfresco-database-user-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: alfresco
        - Key: Component
          Value: database
        - Key: ManagedBy
          Value: CloudFormation

Outputs:
  StartBlockTraffic:
    Description: Begin weekly maintenance window
    Value: !GetAtt MaintenanceWindows.StartBlockTraffic

  StartRotateMasterPasswords:
    Description: When to start rotating master passwords
    Value: !GetAtt MaintenanceWindows.StartRotateMasterPasswords

  StartRotateUserPasswords:
    Description: When to start rotating user passwords
    Value: !GetAtt MaintenanceWindows.StartRotateUserPasswords

  StartRdsBackup:
    Description: When to start backing up RDS instances
    Value: !GetAtt MaintenanceWindows.StartRdsBackup

  EndRdsBackup:
    Description: When to end backing up RDS instances
    Value: !GetAtt MaintenanceWindows.EndRdsBackup

  StartRdsMaintenance:
    Description: When to start maintenance of the RDS instance
    Value: !GetAtt MaintenanceWindows.StartRdsMaintenance

  EndRdsMaintenance:
    Description: When to end maintenance of the RDS instance
    Value: !GetAtt MaintenanceWindows.EndRdsMaintenance

  StartAmazonmqMaintenanceDayOfWeek:
    Description: When to start maintenance of AmazonMQ (day of week)
    Value: !GetAtt MaintenanceWindows.StartAmazonmqMaintenanceDayOfWeek

  StartAmazonmqMaintenanceTimeOfDay:
    Description: When to start maintenance of AmazonMQ (time of day)
    Value: !GetAtt MaintenanceWindows.StartAmazonmqMaintenanceTimeOfDay

  StartAllowTraffic:
    Description: End weekly maintenance window
    Value: !GetAtt MaintenanceWindows.StartAllowTraffic
